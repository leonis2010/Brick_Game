.PHONY: all install uninstall dvi dist test gcov_report check rebuild clean

# –¶–µ–ª–µ–≤–æ–π –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–π —Ñ–∞–π–ª
TARGET = s21_brick_games_terminal_sueannel

# –ö–æ–º–ø–∏–ª—è—Ç–æ—Ä—ã
CC = gcc -g -Wall -Wextra -Werror 
CXX = g++  -g -Wall -Wextra -Werror -std=c++20

# –§–ª–∞–≥–∏ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏
GCOVFLAGS = -fprofile-arcs -ftest-coverage -lncurses
TEST_FLAGS = -D TEST_MODE

# –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞
OS=$(shell uname -s)
Gtest=-lgtest -lgtest_main -pthread
LIBS=$(Gtest)
LINUX=$(Gtest) -lm -lpthread -lrt -lsubunit
ifeq ($(OS), Linux)
 CC += -D OS_LINUX
 CXX += -D OS_LINUX
endif
ifeq ($(OS), Darwin)
 CC += -D OS_MAC
 CXX += -D OS_MAC
endif

# –ü–æ–¥–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –∏ –∑–∞–≥–æ–ª–æ–≤–æ—á–Ω—ã–µ —Ñ–∞–π–ª—ã
SUBDIRS = brick_game/snake/cli_controller \
			brick_game/snake/model \
			gui/cli \
			brick_game/common \
			brick_game/tetris/model \
			brick_game/tetris/controller


# –°–ø–∏—Å–æ–∫ –∏—Å—Ö–æ–¥–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
SOURCES = $(shell find $(SUBDIRS) -type f \( -name '*.c' -o -name '*.cpp' \))

# –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ C –∏ C++ —Ñ–∞–π–ª—ã
C_SOURCES := $(filter %.c,$(SOURCES))
CPP_SOURCES := $(filter %.cpp,$(SOURCES))

# –û–±—ä–µ–∫—Ç–Ω—ã–µ —Ñ–∞–π–ª—ã
C_OBJS := $(patsubst %.c, %.o, $(C_SOURCES))
CPP_OBJS := $(patsubst %.cpp, %.o, $(CPP_SOURCES))
OBJ_LIBRARY := $(C_OBJS) $(CPP_OBJS)

# –°—Ç–∞—Ç–∏—á–µ—Å–∫–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞
STATIC_LIB = s21_terminal_lib_game.a

# –¢–µ—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã
STUBS = tests/curs_set_stub.c
TEST_SOURCE=$(shell find tests -type f -name '*.c' -o -name '*.cpp' )
TEST = $(filter-out tests/curs_set_stub.c, $(TEST_SOURCE))

# –¶–µ–ª–∏
all: clean $(STATIC_LIB) $(TARGET)

# –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
$(STATIC_LIB): $(OBJ_LIBRARY)
	ar rcs $(STATIC_LIB) $(OBJ_LIBRARY)
	ranlib $(STATIC_LIB)
# find . -type f \( -name "*.o" \) -exec rm -f {} \;

# –ö–æ–º–ø–∏–ª—è—Ü–∏—è C —Ñ–∞–π–ª–æ–≤
%.o: %.c
	$(CC) -c $< -o $@

# –ö–æ–º–ø–∏–ª—è—Ü–∏—è C++ —Ñ–∞–π–ª–æ–≤
%.o: %.cpp
	$(CXX) -c $< -o $@

# –°–æ–∑–¥–∞–Ω–∏–µ –∏—Å–ø–æ–ª–Ω—è–µ–º–æ–≥–æ —Ñ–∞–π–ª–∞
$(TARGET): brick_game/main_menu.o $(STATIC_LIB)
	$(CXX) brick_game/main_menu.o -o $(TARGET) $(STATIC_LIB) -lncurses
	
# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
test: COMPILE_FLAGS := $(CXX) $(TEST_FLAGS)
test: $(STATIC_LIB)
ifeq ($(OS), Darwin)
	$(COMPILE_FLAGS) $(TEST) $(STUBS) -o test.out $(STATIC_LIB) $(LIBS) -lncurses
else
	$(COMPILE_FLAGS) $(TEST) $(STUBS) -o test.out $(STATIC_LIB) $(LINUX) -lncurses
endif
	./test.out

# –û—Ç—á–µ—Ç –æ –ø–æ–∫—Ä—ã—Ç–∏–∏ –∫–æ–¥–∞
gcov_report: $(STATIC_LIB) $(TEST)
	mkdir -p gcov_report
ifeq ($(OS), Darwin)	
	gcc $(TEST_FLAGS) $(GCOVFLAGS) $(TEST) $(STUBS) $(SOURCES) -lstdc++ -o gcov_report/report.out $(LIBS)
else
	gcc $(TEST_FLAGS) $(GCOVFLAGS) $(TEST) $(STUBS) $(SOURCES) -lstdc++ -o gcov_report/report.out $(LINUX)
endif
	./gcov_report/report.out	

	lcov -t "–û—Ç—á–µ—Ç –æ –ø–æ–∫—Ä—ã—Ç–∏–∏ gcov –¥–ª—è —Ç–µ—Å—Ç–æ–≤" -o gcov_report/Coverage_Report.info -c -d . \
	--ignore-errors unused \
	--ignore-errors gcov \
	--ignore-errors mismatch --ignore-errors inconsistent \
	--exclude '*/src/tests/*' \
	--exclude '*/src/List/constructors_and_destructor.cpp' \
    --exclude '*/usr/local/include/c++/*' \
    --exclude '*/usr/local/include/gtest/*'

	genhtml -o gcov_report/report/ gcov_report/Coverage_Report.info
	rm -f *.gcno *.gcda *.info gcov_report/report.out *.gcov

ifeq ($(OS), Darwin)
	open gcov_report/report/index-sort-f.html
else
	xdg-open gcov_report/report/index-sort-f.html
endif

show: test
	echo "$(TEST)"
	#valgrind --trace-children=yes --track-origins=yes --track-fds=yes --tool=memcheck --leak-check=full --show-leak-kinds=all --log-file="./report.log" ./test.out
	# cppcheck --enable=all --suppress=missingIncludeSystem $(SOURCES)
	#CK_FORK=no valgrind -s  --trace-children=yes --track-origins=yes --track-fds=yes --tool=memcheck --leak-check=full --show-leak-kinds=all --log-file=RESULT_VALGRIND.txt $(SOURCES)
	valgrind --leak-check=yes --log-file="./report.log" ./test.out  && sync #—É—Ç–µ—á–∫–∏ –∫–∞–∂–¥–æ–≥–æ —Ç–µ—Å—Ç–∞
	#valgrind --leak-check=full --log-file="./report.log" --quiet ./test.out # –º–∏–Ω–∏–º—É–º —Ç–æ–ª—å–∫–æ –æ—à–∏–±–∫–∏ –∏ —É—Ç–µ—á–∫–∏

# –¶–µ–ª—å –¥–ª—è —Å–±–æ—Ä–∫–∏ Qt –≤–µ—Ä—Å–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞
qt: 
	@echo "===== Building Qt version of the project ====="
	@cd gui/desktop/launcher && qmake -o Makefile launcher.pro
	@cd gui/desktop/launcher && $(MAKE)
	@echo "===== Cleaning up Qt build artifacts except executable ====="
	@cd gui/desktop/launcher && rm -f *.o moc_*.cpp ui_*.h qrc_*.cpp moc_predefs.h
	@cd gui/desktop/launcher && rm -f Makefile

# –†—É—á–Ω–∞—è –æ—á–∏	—Å—Ç–∫–∞ Qt-—Å–±–æ—Ä–∫–∏
qt_clean:
	@echo "===== Cleaning Qt build files manually ====="
	@cd gui/desktop/launcher && rm -f *.o moc_*.cpp ui_*.h qrc_*.cpp moc_predefs.h Makefile
	@rm -rf gui/desktop/launcher/GameLauncher.app
	@rm -rf gui/desktop/launcher/GameLauncher
	@rm -rf gcov_report
	@echo "===== Cleaning Qt done ====="

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏—Å–ø–æ–ª–Ω—è–µ–º—ã—Ö —Ñ–∞–π–ª–æ–≤ (—Ç–µ—Ä–º–∏–Ω–∞–ª + Qt .app)
define print_progress
    @printf "–ü—Ä–æ–≥—Ä–µ—Å—Å: [%-20s] %d%%\r" "$(shell printf '=%.0s' {1..$(1)}))" "$(shell echo "$(1)*5" | bc)"
    @sleep 0.1
endef

install: uninstall
	@echo "üöÄ –ù–∞—á–∞–ª–æ —É—Å—Ç–∞–Ω–æ–≤–∫–∏..."
	@echo "1/4 üîß –°–±–æ—Ä–∫–∞ —Ç–µ—Ä–º–∏–Ω–∞–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏..."
	@$(MAKE) -s $(TARGET)
	@echo "2/4 üé® –°–±–æ—Ä–∫–∞ Qt –≤–µ—Ä—Å–∏–∏..."
	@$(MAKE) -s qt
	@echo "3/4 üìÇ –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–ø–∫–∏ bin –≤ –¥–æ–º–∞—à–Ω–µ–º –∫–∞—Ç–∞–ª–æ–≥–µ..."
	@install -d $(HOME)/bin
	@echo "4/4 üì¶ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤..."
	@install -m 755 $(TARGET) $(HOME)/bin
	# –ü–æ–ø—ã—Ç–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å GameLauncher.app, –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (macOS)
	@cp -R gui/desktop/launcher/GameLauncher.app $(HOME)/bin || true
	@cp -R gui/desktop/launcher/GameLauncher $(HOME)/bin || true
	@echo "‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
	@echo "–ò—Å–ø–æ–ª–Ω—è–µ–º—ã–µ —Ñ–∞–π–ª—ã –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤: $(HOME)/bin"

# –£–¥–∞–ª–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
uninstall: clean qt_clean
	rm -f $(HOME)/bin/$(TARGET)
	rm -rf $(HOME)/bin/GameLauncher.app

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
dvi: clean
	$(HOME)/goinfre/homebrew/bin/doxygen Doxyfile
	open docs/html/index.html

# –°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞ —Å –∏—Å—Ö–æ–¥–Ω—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏
dist: clean
	tar -czf s21_tetris_snake.tar.gz \
	$(shell find . -type f \( \
	-name "*.qrc" -o \
	-name "*.user" -o \
	-name "*.pro" -o \
	-name "*.png" -o \
	-name "*.jpg" -o \
	-name "*.jpeg" -o \
	-name "*.c" -o \
	-name "*.cpp" -o \
	-name "*.h" -o \
	-name "Makefile" -o \
	-name "Doxyfile" -o \
	-name "custom.css" \)) \
	$(shell find gui/cli/documentation -type f)

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞
check:
	find . -type f \( -name "*.c" -o -name "*.cpp" -o -name "*.h" \) -exec clang-format -i {} \;

# –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞
rebuild: clean all

# –û—á–∏—Å—Ç–∫–∞
clean:
	@find . -type f \( -name "*.o" -o -name "*.a" -o -name "*.gcno" -o -name "*.gcda" -o -name "*.info" -o -name "*.out" -o -name "*.gcov" -o -name "*.log" \) -exec rm -f {} \;
	@rm -rf ./report
	@rm -rf *.dSYM
	@rm -rf ./docs
	@rm -rf ./s21_tetris_snake.tar.gz
	@rm -rf ./$(TARGET).a
	@rm -rf ./$(TARGET)
	@rm -rf gcov_report
	@echo "*****_clean is done!_*****"

print_sources:
	@echo "Found source files:"
	@echo "$(SOURCES)"

